<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>TapTap Messenger Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #ffffff; --text: #000; --accent: #3390ec; --sidebar: #f0f2f5; }
        body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); color: var(--text); }
        
        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        #sidebar { width: 320px; background: var(--sidebar); border-right: 1px solid #ccc; display: flex; flex-direction: column; }
        .ch-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #ddd; position: relative; }
        .ch-item:hover { background: #e4e6e9; }
        
        /* –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç */
        #chat-area { flex: 1; display: flex; flex-direction: column; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 70%; background: #fff; border: 1px solid #ddd; }
        .msg.my { align-self: flex-end; background: #effdde; }
        
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 350px; color: black; }
        
        /* –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å */
        #admin-btn { display: none; background: #ff9800; color: white; border: none; padding: 10px; cursor: pointer; }
        .premium-star { color: #ffd700; margin-left: 5px; }
        
        .emoji-bar { padding: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div id="profile-modal" class="modal" style="display: flex;">
    <div class="modal-content">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ TapTap</h3>
        <input type="text" id="p-name" placeholder="–ù–∏–∫–Ω–µ–π–º" style="width: 100%; margin-bottom: 10px;">
        <input type="text" id="p-avatar" placeholder="URL –ê–≤–∞—Ç–∞—Ä–∫–∏" style="width: 100%; margin-bottom: 10px;">
        <textarea id="p-bio" placeholder="–û —Å–µ–±–µ" style="width: 100%; margin-bottom: 10px;"></textarea>
        <button onclick="saveProfile()" style="width: 100%">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –≤–æ–π—Ç–∏</button>
    </div>
</div>

<div id="admin-modal" class="modal">
    <div class="modal-content">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ TapTap</h3>
        <input type="text" id="target-email" placeholder="Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        <div style="margin-top: 10px;">
            <button onclick="adminAction('premium')">TapPremium</button>
            <button onclick="adminAction('ban')">–ë–∞–Ω</button>
            <button onclick="adminAction('mute')">–ú—É—Ç</button>
        </div>
        <button onclick="document.getElementById('admin-modal').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<div id="sidebar">
    <div style="padding: 20px; background: var(--accent); color: white;">
        <b>TapTap Messenger</b>
        <button id="admin-btn" onclick="document.getElementById('admin-modal').style.display='flex'">‚öô –ê–¥–º–∏–Ω</button>
    </div>
    <div id="channel-list" style="flex: 1; overflow-y: auto;"></div>
    <button onclick="createNewChannel()">+ –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</button>
</div>

<div id="chat-area">
    <div id="messages"></div>
    <div class="emoji-bar" id="emoji-list"></div>
    <div style="padding: 20px; display: flex; gap: 10px; border-top: 1px solid #ccc;">
        <input type="text" id="mInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex: 1;">
        <button onclick="sendMsg()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://gfivysotgsksshpajkdd.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_obJUY1r0Qbcxsd8RSe9pQQ_ewX4Z2Dz';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let user = null;
    let profile = null;
    let currentCh = null;

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    async function checkUser() {
        const session = await supabase.auth.getSession();
        if (!session.data.session) {
            window.location.href = '/'; // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≤—Ö–æ–¥ –µ—Å–ª–∏ –Ω–µ—Ç —Å–µ—Å—Å–∏–∏
            return;
        }
        user = session.data.session.user;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–¥–º–∏–Ω–∞
        if (user.email === 'elytrabobik302@gmail.com') {
            document.getElementById('admin-btn').style.display = 'block';
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        const { data } = await supabase.from('profiles').select('*').eq('id', user.id).single();
        if (data) {
            profile = data;
            document.getElementById('profile-modal').style.display = 'none';
            loadChannels();
        }
    }

    async function saveProfile() {
        const username = document.getElementById('p-name').value;
        const avatar_url = document.getElementById('p-avatar').value;
        const bio = document.getElementById('p-bio').value;

        const { error } = await supabase.from('profiles').upsert({
            id: user.id, username, avatar_url, bio
        });

        if (!error) location.reload();
    }

    // --- –ö–∞–Ω–∞–ª—ã ---
    async function loadChannels() {
        const { data } = await supabase.from('channels').select('*');
        const list = document.getElementById('channel-list');
        list.innerHTML = '';
        data.forEach(ch => {
            const div = document.createElement('div');
            div.className = 'ch-item';
            div.innerHTML = `<b># ${ch.name}</b><br><small>${ch.description || ''}</small>`;
            div.onclick = () => selectChannel(ch);
            list.appendChild(div);
        });
    }

    async function createNewChannel() {
        const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞:');
        const desc = prompt('–û–ø–∏—Å–∞–Ω–∏–µ:');
        if (name) {
            await supabase.from('channels').insert([{ name, description: desc, created_by: user.id }]);
            loadChannels();
        }
    }

    function selectChannel(ch) {
        currentCh = ch;
        loadMessages();
    }

    // --- –°–æ–æ–±—â–µ–Ω–∏—è –∏ –≠–º–æ–¥–∑–∏ ---
    const emojis = ['üòÄ','üòÇ','üòç','üî•','üëç','üí©','ü§°','üöÄ'];
    const emojiList = document.getElementById('emoji-list');
    emojis.forEach(e => {
        const s = document.createElement('span');
        s.innerText = e;
        s.onclick = () => document.getElementById('mInput').value += e;
        emojiList.appendChild(s);
    });

    async function sendMsg() {
        if (profile.status === 'muted') return alert('–£ –≤–∞—Å –º—É—Ç!');
        const text = document.getElementById('mInput').value;
        if (!text || !currentCh) return;

        await supabase.from('messages').insert([{
            content: text,
            channel_id: currentCh.id,
            author_id: user.id,
            author_name: profile.username + (profile.is_premium ? ' ‚≠ê' : '')
        }]);
        document.getElementById('mInput').value = '';
    }

    async function loadMessages() {
        const { data } = await supabase.from('messages').select('*').eq('channel_id', currentCh.id);
        const box = document.getElementById('messages');
        box.innerHTML = '';
        data.forEach(m => {
            const d = document.createElement('div');
            d.className = `msg ${m.author_id === user.id ? 'my' : ''}`;
            d.innerHTML = `<b>${m.author_name}</b>: ${m.content}`;
            box.appendChild(d);
        });
    }

    // --- –ê–¥–º–∏–Ω—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è ---
    async function adminAction(type) {
        const email = document.getElementById('target-email').value;
        // –¢—É—Ç –Ω—É–∂–Ω–∞ —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ ID –ø–æ Email —á–µ—Ä–µ–∑ RPC –∏–ª–∏ –∞–¥–º–∏–Ω-—Ñ—É–Ω–∫—Ü–∏—é
        // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø—Ä–∏–º–µ—Ä–∞ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ –º—ã –º–µ–Ω—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è —Ç–µ—Å—Ç–∞)
        alert('–î–µ–π—Å—Ç–≤–∏–µ ' + type + ' –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è ' + email);
        // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–¥–µ—Å—å –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è supabase.rpc –∏–ª–∏ –∑–∞–ø—Ä–æ—Å –∫ —Ç–∞–±–ª–∏—Ü–µ profiles
    }

    supabase.channel('messages').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
        if (currentCh && payload.new.channel_id === currentCh.id) loadMessages();
    }).subscribe();

    checkUser();
</script>
</body>
</html>
